{% extends "base.html" %}
{% load static %}

{% block title %}Sales Return{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 p-10">
  <div class="bg-white shadow-xl rounded-2xl p-8 max-w-5xl mx-auto">
    <h2 class="text-3xl font-bold mb-6">‚Ü©Ô∏è Record Product Return</h2>

    <form method="post" id="return-form">
      {% csrf_token %}
      {{ formset.management_form }}

      <!-- Select Invoice -->
      <div class="mb-6">
        <label class="font-semibold text-gray-700">Select Invoice</label>
        <select id="invoice-select" name="invoice" class="border rounded px-2 py-1 w-full">
          <option value="">-- Select Invoice --</option>
          {% for invoice in invoices %}
            <option value="{{ invoice.id }}">Invoice #{{ invoice.invoice_no }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Return Items Table -->
      <table class="min-w-full border rounded-lg mb-4" id="return-table">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-4 py-2 text-left">Product</th>
            <th class="px-4 py-2 text-left">Quantity</th>
            <th class="px-4 py-2 text-left">Reason</th>
            <th class="px-4 py-2 text-left">Action</th>
          </tr>
        </thead>
        <tbody>
          {% for form in formset %}
          <tr class="return-row">
            <td class="px-4 py-2">{{ form.product }}</td>
            <td class="px-4 py-2">{{ form.quantity }}</td>
            <td class="px-4 py-2">{{ form.reason }}</td>
            <td class="px-4 py-2">
              <button type="button" class="remove-row bg-red-500 text-white px-2 py-1 rounded">‚ùå</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <button type="button" id="add-item" class="bg-green-600 text-black px-4 py-2 rounded hover:bg-green-700 mb-4">
        ‚ûï Add Item
      </button>

      <div class="flex justify-end">
        <button type="submit" class="bg-blue-600 text-black px-6 py-3 mt-4 rounded-lg font-semibold hover:bg-blue-700">
          üíæ Save Return
        </button>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const tableBody = document.querySelector("#return-table tbody");
    const addBtn = document.getElementById("add-item");
    const totalForms = document.querySelector("#id_form-TOTAL_FORMS");
    const invoiceSelect = document.getElementById("invoice-select");

    // 1Ô∏è‚É£ Load invoice items via Ajax
    invoiceSelect.addEventListener("change", () => {
        const invoiceId = invoiceSelect.value;
        if (!invoiceId) return;

        fetch(`/sales/invoice-items/${invoiceId}/`)
            .then(response => response.json())
            .then(data => {
                // Clear existing rows
                tableBody.innerHTML = "";

                data.items.forEach((item, index) => {
                    const row = document.createElement("tr");
                    row.classList.add("return-row");
                    row.innerHTML = `
                        <td class="px-4 py-2">
                            <select name="form-${index}-product" class="border rounded px-2 py-1 w-full">
                                <option value="${item.product}" selected>${item.product_name}</option>
                            </select>
                        </td>
                        <td class="px-4 py-2">
                            <input type="number" name="form-${index}-quantity" value="${item.quantity}" step="0.01" class="border rounded px-2 py-1 w-full">
                        </td>
                        <td class="px-4 py-2">
                            <input type="text" name="form-${index}-reason" class="border rounded px-2 py-1 w-full">
                        </td>
                        <td class="px-4 py-2">
                            <button type="button" class="remove-row bg-red-500 text-white px-2 py-1 rounded">‚ùå</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                totalForms.value = data.items.length;
            });
    });

    // 2Ô∏è‚É£ Add new empty row
    addBtn.addEventListener("click", () => {
        const formNum = parseInt(totalForms.value);
        const newRow = document.createElement("tr");
        newRow.classList.add("return-row");
        newRow.innerHTML = `
            <td class="px-4 py-2">
                <select name="form-${formNum}-product" class="border rounded px-2 py-1 w-full">
                    <option value="">-- Select Product --</option>
                </select>
            </td>
            <td class="px-4 py-2">
                <input type="number" name="form-${formNum}-quantity" step="0.01" class="border rounded px-2 py-1 w-full">
            </td>
            <td class="px-4 py-2">
                <input type="text" name="form-${formNum}-reason" class="border rounded px-2 py-1 w-full">
            </td>
            <td class="px-4 py-2">
                <button type="button" class="remove-row bg-red-500 text-white px-2 py-1 rounded">‚ùå</button>
            </td>
        `;
        tableBody.appendChild(newRow);
        totalForms.value = formNum + 1;
    });

    // 3Ô∏è‚É£ Remove row
    tableBody.addEventListener("click", e => {
        if (e.target.classList.contains("remove-row")) {
            const row = e.target.closest("tr");
            row.remove();

            const forms = tableBody.querySelectorAll("tr.return-row");
            totalForms.value = forms.length;

            forms.forEach((row, index) => {
                row.querySelectorAll("input, select").forEach(input => {
                    input.name = input.name.replace(/form-\d+-/, `form-${index}-`);
                });
            });
        }
    });
});
</script>
{% endblock %}

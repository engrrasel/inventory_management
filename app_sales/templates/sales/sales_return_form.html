{% extends "base.html" %}
{% load static %}

{% block title %}Sales Return{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 p-10">
  <div class="bg-white shadow-xl rounded-2xl p-8 max-w-5xl mx-auto">
    <h2 class="text-3xl font-bold mb-6">ðŸ”„ Return Sale</h2>

    <form method="post">
      {% csrf_token %}

      <div class="grid grid-cols-2 gap-6 mb-8">
        <!-- Select Invoice -->
        <div>
          <label class="font-semibold text-gray-700">Invoice</label>
          <select name="invoice" id="invoice" class="border rounded px-3 py-2 w-full">
            <option value="">Select Invoice</option>
            {% for inv in invoices %}
              <option value="{{ inv.id }}" {% if selected_invoice and selected_invoice.id == inv.id %}selected{% endif %}>
                #{{ inv.invoice_no }} - {{ inv.customer.name }}
              </option>
            {% endfor %}
          </select>
          {% if form.errors.invoice %}
            <p class="text-red-500 text-sm">{{ form.errors.invoice }}</p>
          {% endif %}
        </div>

        <!-- Date -->
        <div>
          <label class="font-semibold text-gray-700">Return Date</label>
          <input type="date" name="date" value="{{ form.date.value|default_if_none:today }}" class="border rounded px-3 py-2 w-full">
          {% if form.errors.date %}
            <p class="text-red-500 text-sm">{{ form.errors.date }}</p>
          {% endif %}
        </div>
      </div>

      <h3 class="text-2xl font-semibold mb-3">ðŸ›’ Returned Items</h3>
      <div class="overflow-x-auto border rounded-lg">
        <table class="min-w-full text-sm" id="return-table">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-4 py-2 text-left">Product</th>
              <th class="px-4 py-2 text-left">Quantity</th>
              <th class="px-4 py-2 text-left">Reason</th>
              <th class="px-4 py-2 text-left">Remove</th>
            </tr>
          </thead>
          <tbody>
            {{ formset.management_form }}
            {% for form in formset %}
            <tr class="return-row">
              {{ form.id }}    <!-- Hidden ID field -->
              {{ form.DELETE }} <!-- Hidden DELETE checkbox -->

              <td class="px-4 py-2">{{ form.product }}</td>
              <td class="px-4 py-2">{{ form.quantity }}</td>
              <td class="px-4 py-2">{{ form.reason }}</td>
              <td class="px-4 py-2">
                <button type="button" class="remove-row bg-red-500 text-white px-2 py-1 rounded">âœ–</button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="flex justify-between items-center mt-6">
        <button type="button" id="add-return-item"
          class="bg-green-600 text-black px-4 py-2 rounded hover:bg-green-700">âž• Add Item</button>
      </div>

      <div class="flex justify-end mt-8">
        <button type="submit"
          class="bg-blue-600 text-black px-6 py-3 rounded-lg font-semibold hover:bg-blue-700">ðŸ’¾ Save Return</button>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const tableBody = document.querySelector("#return-table tbody");
  const addBtn = document.getElementById("add-return-item");
  const totalForms = document.querySelector("#id_form-TOTAL_FORMS");

  // Add new return row dynamically
  addBtn.addEventListener("click", () => {
    const formNum = parseInt(totalForms.value);
    const lastRow = tableBody.querySelector("tr:last-child");
    const newRow = lastRow.cloneNode(true);

    newRow.querySelectorAll("input, select, textarea").forEach(input => {
      if (input.name) {
        input.name = input.name.replace(/-\d+-/, `-${formNum}-`);
        input.id = input.id.replace(/-\d+-/, `-${formNum}-`);
      }

      if (input.type === "hidden") {
        if (input.name.endsWith("id")) input.value = "";
        if (input.name.endsWith("DELETE")) input.checked = false;
      } else {
        input.value = "";
      }
    });

    tableBody.appendChild(newRow);
    totalForms.value = formNum + 1;
  });

  // Remove row
  tableBody.addEventListener("click", e => {
    if (e.target.classList.contains("remove-row")) {
      const row = e.target.closest("tr");
      const deleteInput = row.querySelector('input[type="checkbox"][name$="DELETE"]');
      if (deleteInput) {
        deleteInput.checked = true;
        row.style.display = "none"; // Hide row visually
      } else {
        row.remove();
      }
    }
  });
});
</script>
{% endblock %}

{% extends "base.html" %}
{% load static %}

{% block title %}Create Sale{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 p-10">
  <div class="bg-white shadow-xl rounded-2xl p-8 max-w-5xl mx-auto">
    <h2 class="text-3xl font-bold mb-6">üßæ Create New Sale</h2>

    <form method="post">
      {% csrf_token %}
      <div class="grid grid-cols-2 gap-6 mb-8">
        {% for field in invoice_form %}
        <div>
          <label class="font-semibold text-gray-700">{{ field.label }}</label>
          {{ field }}
          {% for error in field.errors %}
            <p class="text-red-500 text-sm">{{ error }}</p>
          {% endfor %}
        </div>
        {% endfor %}
      </div>

      <h3 class="text-2xl font-semibold mb-3">üõçÔ∏è Sale Items</h3>
      <div class="overflow-x-auto border rounded-lg">
        <table class="min-w-full text-sm" id="sales-table">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-4 py-2 text-left">Product</th>
              <th class="px-4 py-2 text-left">Quantity</th>
              <th class="px-4 py-2 text-left">Unit Price</th>
              <th class="px-4 py-2 text-left">Total</th>
            </tr>
          </thead>
          <tbody>
            {{ formset.management_form }}
            {% for form in formset %}
            <tr class="sale-row">
              <td class="px-4 py-2">{{ form.product }}</td>
              <td class="px-4 py-2">{{ form.quantity }}</td>
              <td class="px-4 py-2">{{ form.unit_price }}</td>
              <td class="px-4 py-2 total">0.00</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="flex justify-between items-center mt-6">
        <button type="button" id="add-item"
          class="bg-green-600 text-black px-4 py-2 rounded hover:bg-green-700">‚ûï Add Item</button>

        <div class="text-right">
          <p>Subtotal: <span id="subtotal">0.00</span></p>
          <p class="font-bold text-xl">Total: <span id="grandtotal">0.00</span></p>
        </div>
      </div>
      

      <div class="flex justify-end mt-8">
        <button type="submit"
          class="bg-blue-600 text-black px-6 py-3 rounded-lg font-semibold hover:bg-blue-700">üíæ Save Sale</button>

    </form>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const tableBody = document.querySelector("#sales-table tbody");
  const addBtn = document.getElementById("add-item");
  const totalForms = document.querySelector("#id_form-TOTAL_FORMS");

  // üßÆ Update totals
  function updateTotals() {
    let subtotal = 0;
    document.querySelectorAll(".sale-row").forEach(row => {
      const qty = parseFloat(row.querySelector('[name$="quantity"]').value) || 0;
      const price = parseFloat(row.querySelector('[name$="unit_price"]').value) || 0;
      const totalCell = row.querySelector(".total");
      totalCell.textContent = (qty * price).toFixed(2);
      subtotal += qty * price;
    });
    document.getElementById("subtotal").textContent = subtotal.toFixed(2);
    document.getElementById("grandtotal").textContent = subtotal.toFixed(2);
  }

  // üÜï Add new form row dynamically
  addBtn.addEventListener("click", () => {
    const formNum = parseInt(totalForms.value);
    const newForm = tableBody.querySelector("tr").cloneNode(true);
    newForm.querySelectorAll("input, select").forEach(input => {
      input.name = input.name.replace(`-${formNum - 1}-`, `-${formNum}-`);
      input.id = input.id.replace(`-${formNum - 1}-`, `-${formNum}-`);
      input.value = "";
    });
    tableBody.appendChild(newForm);
    totalForms.value = formNum + 1;
  });

  // üßÆ Listen for input updates
  tableBody.addEventListener("input", e => {
    if (e.target.matches('[name$="quantity"], [name$="unit_price"]')) {
      updateTotals();
    }
  });
});
</script>
{% endblock %}
